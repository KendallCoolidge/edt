<!-- A build file for use with Hudson. Note that forceContextQualifier 
	 is being set, which overrides tag/branch values found in *.map files 
-->
<project default="run">
	<property environment="env"/>
	<property name="WORKSPACE" value="${env.WORKSPACE}"/>
	<property file="build.properties" />

	<tstamp>
		<format property="buildTimestamp" pattern="yyyyMMddHHmm" />
	</tstamp>
	<property name="forceContextQualifier" value="v${buildTimestamp}" />
	
	<property name="fetchTag" value="HEAD" />
	
	<property name="relengBuilderDir" value="${basedir}" />
	<dirname file="${relengBuilderDir}" property="workspaceDir" />
	
	<property name="writableBuildRoot" value="/tmp/build" />

	<property name="buildDir" value="${writableBuildRoot}/${buildType}${buildTimestamp}" /> 		
		
	<target name="init">
		<delete dir="${buildDir}" failonerror="false"/>
	</target>

	<target name="run" depends="init">
		<echo message="Workspace: ${WORKSPACE}"/>
		<echo message="Writable Build Root: ${writableBuildRoot}"/>
		<mkdir dir="${writableBuildRoot}"/>
		<property name="relengCommonBuilderDir" value="/opt/public/cbi/build/org.eclipse.dash.common.releng" />
		<property name="relengBaseBuilderDir" value="/opt/public/cbi/build/org.eclipse.releng.basebuilder" />
		<ant antfile="${relengCommonBuilderDir}/buildAll.xml" target="runEclipse" dir="${relengCommonBuilderDir}" />

		<antcall target="cleanUp" inheritall="true" />
		<condition property="isNightlyBuild">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
<!-- *** FOR DEBUGGING *** ...why aren't we deleting anything?!? -->
<echo>isNightlyBuild is [ ${isNightlyBuild} ]</echo>
<!-- end of stuff for debugging -->
		<antcall target="deleteOldNightlies" inheritall="true" />

		<ant antfile="promote.xml" />
	</target>
	 
	<target name="cleanUp">
<!-- *** FOR DEBUGGING *** ...why aren't we deleting anything?!? -->
<echo>in cleanUp</echo>
<!-- end of stuff for debugging -->
		<delete dir="${buildDir}/eclipse" failonerror="false" />
		<delete dir="${buildDir}/testing" failonerror="false" />
		<delete dir="${buildDir}/compilelogs" failonerror="false"/>
		<delete dir="${buildDir}/testresults/consolelogs" failonerror="false"/>
		<delete dir="${buildDir}/testresults/html" failonerror="false"/>
		<delete>
			<fileset dir="${writableBuildRoot}">
				<include name="**/*AllFeatures*.zip"/>
				<include name="**/*Master*.zip"/>
			</fileset>
		</delete>
	</target>	

	<target name="deleteOldNightlies" if="isNightlyBuild">

<!-- *** FOR DEBUGGING *** ...why aren't we deleting anything?!? -->
<path id="nightlies.path">
	<fileset dir="${writableBuildRoot}">
		<include name="N20*" />
		<exclude name="N${buildTimestamp}" />
	</fileset>
</path>
<pathconvert pathsep="${line.separator}|   |-- "
	property="nightlies.path.compile"             
	refid="nightlies.path">
</pathconvert>
<echo>nightlies.path.compile is [ ${nightlies.path.compile} ]</echo>

<path id="nightlies.path2">
	<dirset dir="${writableBuildRoot}" includes="N20*" excludes="N${buildTimestamp}" />
</path>
<pathconvert pathsep="${line.separator}|   |-- "
	property="nightlies.path.compile2"             
	refid="nightlies.path2">
</pathconvert>
<echo>nightlies.path.compile2 is [ ${nightlies.path.compile2} ]</echo>
<!-- end of stuff for debugging -->

		<delete failonerror="false">
			<fileset dir="${writableBuildRoot}">
				<include name="N20*" />
				<exclude name="N${buildTimestamp}" />
			</fileset>
		</delete>
	</target>
</project>
